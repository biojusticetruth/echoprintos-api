<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EchoprintOS â€¢ Ledger</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./theme.css?v=21" />

  <!-- Small visual overrides -->
  <style>
    /* Top nav tweaks */
    .nav .brand { text-decoration:none; }
    .nav a.brand:hover { opacity:.9 }

    /* Hero card a bit more transparent / airy */
    .hero-glass {
      --hero-bg: rgba(15,22,28,.35);
      --hero-brd: rgba(255,255,255,.08);
      background: var(--hero-bg);
      border: 1px solid var(--hero-brd);
      backdrop-filter: blur(12px) saturate(140%);
    }

    /* Verify layout */
    .verify-card .btn.primary { font-weight:600; }
    .btn-reset {
      background: transparent; border:1px solid rgba(255,255,255,.08);
      color: rgba(255,255,255,.75); box-shadow:none;
    }
    .btn-reset:hover { color:#fff; border-color:rgba(255,255,255,.15); }
    .btn-paste {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
    }
    .btn-paste:hover { background: rgba(255,255,255,.08); }

    /* Hide the result box unless we have content */
    #verifyResult { display:none; }
    #verifyResult.show { display:block; margin-top:.5rem; }

    /* Recent grid as individual glow cards */
    .recent-grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(280px,1fr));
      gap: 14px;
    }
    .recent-card {
      background: rgba(20,26,32,.40);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 14px 16px;
      position: relative;
      overflow: hidden;
    }
    .recent-card:before {
      content:"";
      position:absolute; inset:-30% -30%;
      background: radial-gradient(120px 120px at 20% 0%,
                rgba(0,255,200,.18), transparent 60%);
      filter: blur(24px);
      opacity:.55; pointer-events:none;
    }
    .recent-card a { color: #9afadf; text-decoration:none; }
    .recent-card a:hover { text-decoration:underline; }
    .recent-meta { font-size:.86rem; opacity:.75; line-height:1.25; }
    .recent-ecp  { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    /* Make hero less top-heavy on phones */
    @media (max-width: 540px){
      .hero-glass { padding-top: 18px; padding-bottom: 18px; }
    }
  </style>
</head>
<body>

  <!-- Top Nav (glass) -->
  <header class="nav">
    <div class="wrap">
      <div class="row">
        <a class="brand" href="https://echoprintos.org" target="_blank" rel="noopener">EchoprintOS</a>
        <a class="active" href="/ledger/">Ledger</a>
        <!-- Capture removed by request -->
        <a href="/about/">About</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Hero glass card -->
    <section class="card glass edge glow-corners sheen hero-glass">
      <span class="pill">LEDGER</span>
      <h1 class="display">EchoprintOS Provenance Layer</h1>
      <p class="lead">
        The BioJustice Institute maintains EchoprintOS â€” a cryptographic timestamping
        network that preserves authorship integrity across systems. Each Echoprint is
        a verifiable record of care: hashed, timestamped, and stored transparently.
      </p>
    </section>

    <!-- Verify -->
    <section class="card glass sheen verify-card">
      <div class="row space-between">
        <h2>Verification</h2>
        <button id="btnReset" class="btn btn-reset">Reset</button>
      </div>

      <!-- Two inputs; either one works. Second mirrors into the first. -->
      <div class="stack">
        <input id="q" class="input" type="text" inputmode="text" autocomplete="off"
               placeholder="EchoprintOS Record ID (ECP-â€¦)" />
        <input id="hashInput" class="input" type="text" inputmode="text" autocomplete="off"
               placeholder="Or enter full SHA-256 hash" />
        <button id="btnVerify" class="btn primary">Verify Record</button>
        <button id="btnPaste" class="btn btn-paste">Paste</button>
      </div>

      <div id="verifyResult" class="result"></div>
      <p class="tip">Verify by EchoprintOS Record ID or 64-hex hash. The ledger below is the canonical artifact.</p>
    </section>

    <!-- Recent -->
    <section class="card glass">
      <div class="row space-between">
        <h2>Recent</h2>
        <small id="recentStatus" class="muted">Loadingâ€¦</small>
      </div>
      <div id="recent" class="recent-grid"></div>
    </section>
  </main>

  <!-- Recent list loader (Supabase REST) -->
  <script>
  (async () => {
    // ðŸ” Supabase read-only (leave as-is)
    const SUPABASE_URL = 'https://cyndhzyfaffprdebclnw.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5bmRoenlmYWZmcHJkZWJjbG53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0OTQxNDUsImV4cCI6MjA3NzA3MDE0NX0.DynJLTGOKDlvLPy_W5jThsWYANens2yGKzY8am6XD6c';

    const statusEl = document.getElementById('recentStatus');
    const gridEl   = document.getElementById('recent');

    const pad = (n,l=2)=>String(n).padStart(l,'0');
    const ecpFromTs = (isoOrTs) => {
      const d = new Date(isoOrTs);
      if (isNaN(d)) return null;
      // Build ECP-YYYYMMDDHHMMSSmmm in UTC
      return `ECP-${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}`
           + `${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}${pad(d.getUTCMilliseconds(),3)}`;
    };
    const fmtUTC = (isoOrTs) => {
      const d = new Date(isoOrTs);
      return isNaN(d) ? '' : d.toISOString().replace('Z','+00:00');
    };

    function cardHtml(r){
      // pick a timestamp field in priority order
      const ts = r.timestamp_iso || r.timestamp || r.created_at || r.created_iso;
      const ecp = ecpFromTs(ts);
      const when = fmtUTC(ts);
      const title = (r.title && r.title.trim()) ? r.title.trim() : '(untitled)';
      const linkOpen = r.url ? `<a href="${r.url}" target="_blank" rel="noopener">` : '<span>';
      const linkClose = r.url ? '</a>' : '</span>';

      // separate glow card
      return `
        <div class="recent-card sheen">
          <div class="recent-title">${linkOpen}${escapeHtml(title)}${linkClose}</div>
          <div class="recent-meta">
            ${ecp ? `<div class="recent-ecp">${ecp}</div>` : ``}
            ${when ? `<div>${when} <span style="opacity:.65">UTC</span></div>` : ``}
          </div>
        </div>`;
    }

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;')
                                         .replace(/</g,'&lt;').replace(/>/g,'&gt;')
                                         .replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    try {
      const qs = [
        'select=title,url,hash,timestamp,timestamp_iso,created_at,created_iso',
        'order=created_at.desc',
        'limit=12'
      ].join('&');

      const res = await fetch(`${SUPABASE_URL}/rest/v1/echoprints?${qs}`, {
        headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
        cache: 'no-store'
      });

      if (!res.ok) { statusEl.textContent = `Read error: ${res.status}`; return; }

      const rows = await res.json();
      if (!rows.length) { statusEl.textContent = 'No records yet.'; return; }

      statusEl.textContent = '';
      gridEl.innerHTML = rows.map(cardHtml).join('');
    } catch (e) {
      statusEl.textContent = 'Read error.'; console.error(e);
    }
  })();

  // Verify UI niceties (keeps your existing main.hard.js behavior)
  (function wireVerifyUI(){
    const q = document.getElementById('q');
    const hash = document.getElementById('hashInput');
    const pasteBtn = document.getElementById('btnPaste');
    const resetBtn = document.getElementById('btnReset');
    const result = document.getElementById('verifyResult');

    // Mirror secondary field into the primary one main.hard.js uses.
    hash.addEventListener('input', () => { q.value = hash.value; });

    pasteBtn.addEventListener('click', async () => {
      try {
        const txt = await navigator.clipboard.readText();
        if (!document.activeElement || document.activeElement === document.body) {
          q.value = txt; hash.value = txt;
        } else {
          document.activeElement.value = txt;
          if (document.activeElement === q) hash.value = txt;
          if (document.activeElement === hash) q.value = txt;
        }
      } catch {}
    });

    resetBtn.addEventListener('click', () => {
      q.value = ''; hash.value = '';
      result.textContent = ''; result.classList.remove('show');
    });

    // If your /ledger/js/main.hard.js writes into #verifyResult, show it.
    const obs = new MutationObserver(() => {
      if (result.textContent.trim()) result.classList.add('show');
    });
    obs.observe(result, { childList: true, subtree: true, characterData: true });
  })();
  </script>

  <!-- Your existing verification logic (unchanged) -->
  <script type="module" src="/ledger/js/main.hard.js?v=21"></script>
</body>
</html>
