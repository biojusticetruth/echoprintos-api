<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EchoprintOS — Verify & Posts</title>
<style>
  :root{--bg:#0b0f12;--fg:#e8ecef;--card:#12171b;--line:#232a31;--acc:#29d9e7}
  *{box-sizing:border-box}
  body{font:16px/1.5 Inter,system-ui,Segoe UI,Arial;margin:0;background:var(--bg);color:var(--fg)}
  a{color:var(--acc);text-decoration:none}
  .wrap{max-width:980px;margin:40px auto;padding:0 18px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:22px;margin:0}
  nav{display:flex;gap:8px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0f1418;cursor:pointer}
  .tab.active{outline:2px solid var(--acc)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin:14px 0}
  input[type=text],select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0f1418;color:var(--fg)}
  button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#161d23;color:var(--fg);cursor:pointer}
  button+button{margin-left:8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .muted{opacity:.75;font-size:13px}
  details{background:#0f1418;border-radius:8px;padding:10px;margin-top:8px;border:1px solid var(--line)}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;margin-right:6px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
  @media(min-width:680px){ .grid{grid-template-columns:1fr 1fr} }
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  /* Overlay (Quick view + Certificate) */
  .cert-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;display:none;align-items:center;justify-content:center;padding:24px}
  .cert-card{background:#fff;color:#111;max-width:720px;width:min(720px,100%);max-height:85vh;overflow:auto;border-radius:12px;border:1px solid #ddd;padding:24px}
  .cert-card h1{font-size:22px;margin:0 0 12px}
  .cert-card .m{color:#666;font-size:13px}
  .cert-card .row{margin:8px 0}
  .cert-actions{display:flex;gap:8px;margin-top:12px}
  .cert-btn{padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:#f8f8f8;cursor:pointer}
</style>

<div class="wrap">
  <header>
    <h1>EchoprintOS</h1>
    <nav>
      <a class="tab" data-tab="verify" href="#verify">Verify</a>
      <a class="tab" data-tab="posts"  href="#posts">Posts</a>
    </nav>
  </header>

  <!-- VERIFY -->
  <section id="view-verify" class="card" hidden>
    <h2 style="margin:0 0 8px 0;font-size:18px">Verify an Echoprint</h2>
    <label class="muted">Paste a SHA-256 hash or a permalink</label>
    <input id="q" type="text" placeholder="e.g., 6f1a… or https://substack.com/p/…">
    <div class="row">
      <button id="btnVerify">Verify</button>
      <button id="btnRecent" title="Show recent">Recent</button>
      <button id="btnClear"  title="Clear">Clear</button>
    </div>
    <div id="out" style="margin-top:14px"></div>
  </section>

  <!-- POSTS -->
  <section id="view-posts" class="card" hidden>
    <h2 style="margin:0 0 8px 0;font-size:18px">Echoprinted Posts</h2>
    <div class="toolbar">
      <select id="platform">
        <option value="">All platforms</option>
        <option>Substack</option><option>LinkedIn</option><option>X</option>
        <option>Instagram</option><option>YouTube</option>
      </select>
      <input id="search" type="text" placeholder="Search title…">
      <label style="display:flex;align-items:center;gap:6px;opacity:.85">
        <input id="imgonly" type="checkbox"> with image only
      </label>
      <button id="refresh">Refresh</button>
    </div>
    <div id="list" class="grid"></div>
    <div class="row" style="justify-content:center">
      <button id="more">Load more</button>
    </div>
  </section>
</div>

<!-- Overlay root -->
<div id="certOverlay" class="cert-backdrop" role="dialog" aria-modal="true"></div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  /* ===== SUPABASE (PASTE YOUR VALUES) ===== */
  const supabase = createClient(
    'https://cyndhzyfaffprdebclnw.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5bmRoenlmYWZmcHJkZWJjbG53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0OTQxNDUsImV4cCI6MjA3NzA3MDE0NX0.DynJLTGOKDlvLPy_W5jThsWYANens2yGKzY8am6XD6c'
  )
  /* ======================================= */

  // helpers
  const $  = (id)=>document.getElementById(id)
  const qs = (s)=>document.querySelector(s)
  const out = $('out'), list = $('list'), overlay = $('certOverlay')
  let page=0, pageSize=12, lastKey=''
  const REC = new Map()
  const fmt = ts => ts ? new Date(ts).toISOString().slice(0,19).replace('T',' ') : ''
  const keyOf = (r)=> r.record_id || r.hash || r.perma_link || r.permalink || r.id || ''

  // best-effort title (for older rows)
  const displayTitle = (r)=>{
    const pick = v => typeof v==='string' && v.trim()
    if(pick(r.title))       return r.title.trim()
    if(pick(r.post_title))  return r.post_title.trim()
    if(pick(r.headline))    return r.headline.trim()
    if(pick(r.name))        return r.name.trim()
    if(pick(r.caption))     return r.caption.trim()
    if(pick(r.text))        return (r.text.trim().length>140? r.text.trim().slice(0,140)+'…' : r.text.trim())
    const link = r.perma_link || r.permalink
    if(pick(link)){
      try{
        const u = new URL(link)
        const last = u.pathname.split('/').filter(Boolean).pop() || ''
        if(last) return decodeURIComponent(last).replace(/[-_]+/g,' ').trim()
      }catch(e){}
    }
    return 'Untitled'
  }

  // where the image might live (older rows used different column names)
  const imgOf = (r)=> r.url || r.image_url || r.image || r.media_url || r.media || r.photo || r.photo_url || r.thumb_url || r.file_url || null
  const linkOf = (r)=> r.perma_link || r.permalink || r.permalink_url || r.link || null

  // tabs/router
  function setTab(tab){
    const isVerify = tab==='verify'
    qs('#view-verify').hidden = !isVerify
    qs('#view-posts').hidden  =  isVerify
    document.querySelectorAll('.tab').forEach(a=>a.classList.toggle('active', a.dataset.tab===tab))
    if(isVerify){ $('q').focus() }
  }
  function route(){ const tab=(location.hash||'#verify').slice(1) || 'verify'; setTab(tab); if(tab==='posts'){ fetchPosts(true) } }
  window.addEventListener('hashchange', route)

  /* ===== Overlays ===== */
  function openCertificate(r){
    const ts = r.sent_at || r.created_at || null
    const esc = s => String(s ?? '').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))
    overlay.innerHTML = `
      <div class="cert-card">
        <h1>Echoprint Certificate</h1>
        <div class="m">schema: echoprint.v1</div>
        <div class="row"><strong>Record ID:</strong> <code>${esc(r.record_id || '')}</code></div>
        <div class="row"><strong>Timestamp:</strong> ${ts ? new Date(ts).toISOString() : ''}</div>
        <div class="row"><strong>Hash (SHA-256):</strong> <code>${esc(r.hash || '')}</code></div>
        <div class="cert-actions">
          <button class="cert-btn" onclick="window.print()">Print</button>
          <button class="cert-btn" id="closeCert">Close</button>
        </div>
      </div>`
    overlay.style.display = 'flex'
    $('closeCert').onclick = ()=> overlay.style.display = 'none'
    overlay.onclick = (e)=>{ if(e.target === overlay) overlay.style.display = 'none' }
  }

  function openQuickView(r){
    const ts = r.sent_at || r.created_at || null
    const esc = s => String(s ?? '').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))
    overlay.innerHTML = `
      <div class="cert-card">
        <h1>Quick view</h1>
        <div class="row"><strong>Record ID:</strong> <code>${esc(r.record_id || '')}</code></div>
        <div class="row"><strong>Timestamp:</strong> ${ts ? new Date(ts).toISOString() : ''}</div>
        <div class="row"><strong>Hash (SHA-256):</strong> <code>${esc(r.hash || '')}</code></div>
        <div class="cert-actions">
          <button class="cert-btn" data-action="cert" data-key="${keyOf(r)}">Certificate</button>
          <button class="cert-btn" data-action="json"  data-key="${keyOf(r)}">Download JSON</button>
          <button class="cert-btn" id="closeQV">Close</button>
        </div>
      </div>`
    overlay.style.display = 'flex'
    $('closeQV').onclick = ()=> overlay.style.display = 'none'
    overlay.onclick = (e)=>{ if(e.target === overlay) overlay.style.display = 'none' }
  }

  function downloadJSON(r){
    const ts = r.sent_at || r.created_at || null
    const cert = {
      schema: "echoprint.v1",
      record_id: r.record_id ?? null,
      timestamp_iso: ts ? new Date(ts).toISOString() : null,
      hash: r.hash ?? null
    }
    const blob = new Blob([JSON.stringify(cert, null, 2)], { type: 'application/json' })
    const a = document.createElement('a')
    a.href = URL.createObjectURL(blob)
    const base = (r.record_id || r.hash || 'echoprint').slice(0, 16)
    a.download = `${base}.echoprint.json`
    a.click()
    URL.revokeObjectURL(a.href)
  }

  document.addEventListener('click', (e)=>{
    const t = e.target.closest('[data-action]'); if(!t) return
    e.preventDefault()
    const r = REC.get(t.dataset.key); if(!r) return
    if(t.dataset.action==='kv')   openQuickView(r)
    if(t.dataset.action==='cert') openCertificate(r)
    if(t.dataset.action==='json') downloadJSON(r)
  })

  /* ===== VERIFY ===== */
  function renderVerify(rows){
    if(!rows || rows.length===0){ out.innerHTML='<div class="muted">No records found.</div>'; return }
    out.innerHTML = rows.map(r=>{
      const key = keyOf(r)
      const img = imgOf(r)
      return `
      <details>
        <summary style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <strong>${displayTitle(r)}</strong>
          <span>${fmt(r.sent_at || r.created_at)}</span>
        </summary>
        <div style="margin-top:8px">
          <div class="muted">record_id:</div>
          <div style="word-break:break-all">${r.record_id || ''}</div>
          ${linkOf(r)?`<div class="muted" style="margin-top:6px">permalink:</div>
                        <div><a target="_blank" href="${linkOf(r)}" rel="noopener">Open post</a></div>`:''}
          ${img?`<div class="muted" style="margin-top:6px">media:</div>
                 <div><a target="_blank" href="${img}" rel="noopener">View image</a></div>
                 <details style="margin-top:6px"><summary>Preview</summary>
                   <img src="${img}" referrerpolicy="no-referrer"
                        style="max-width:100%;border-radius:8px;border:1px solid var(--line);margin-top:8px">
                 </details>`:''}
          <div class="row" style="margin-top:6px">
            <a href="#" data-action="kv"   data-key="${key}">Quick view</a>
            <a href="#" data-action="cert" data-key="${key}">View certificate</a>
            <a href="#" data-action="json" data-key="${key}">Download JSON</a>
          </div>
        </div>
      </details>`
    }).join('')
    rows.forEach(r => REC.set(keyOf(r), r))
  }

  $('btnVerify').onclick = async ()=>{
    const v = $('q').value.trim()
    if(!v){ out.innerHTML='<div class="muted">Enter a hash or permalink URL.</div>'; return }
    const isHash = /^[a-f0-9]{64}$/i.test(v)
    let data, error
    if(isHash){
      ({data, error} = await supabase.from('echoprints').select('*').eq('hash', v).limit(5))
    }else{
      ({data, error} = await supabase.from('echoprints').select('*').eq('perma_link', v).limit(5))
      if((!data || data.length===0) && !error){
        ({data, error} = await supabase.from('echoprints').select('*').eq('permalink', v).limit(5))
      }
    }
    out.innerHTML = error ? `<div class="muted">Error: ${error.message}</div>` : ''
    if(!error) renderVerify(data)
  }

  $('btnRecent').onclick = async ()=>{
    const { data, error } = await supabase.from('echoprints')
      .select('*').order('sent_at',{ascending:false}).range(0,9)
    out.innerHTML = error ? `<div class="muted">Error: ${error.message}</div>` : ''
    if(!error) renderVerify(data)
  }
  $('btnClear').onclick = ()=>{ $('q').value=''; out.innerHTML='' }

  /* ===== POSTS ===== */
  function postCard(r){
    const key = keyOf(r)
    const dt  = fmt(r.sent_at || r.created_at)
    const img = imgOf(r)
    return `<div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <strong>${displayTitle(r)}</strong>
        <div>${dt?`<span class="pill">${dt}</span>`:''}</div>
      </div>
      <div class="muted" style="margin-top:6px">record_id:</div>
      <div style="word-break:break-all">${r.record_id || ''}</div>
      <div class="row" style="margin-top:6px">
        ${linkOf(r)?`<a target="_blank" href="${linkOf(r)}" rel="noopener">Open post</a>`:''}
        ${img?`<a target="_blank" href="${img}" rel="noopener">View image</a>`:''}
        ${r.hash?`<a href="#verify" onclick="document.getElementById('q').value='${r.hash}';document.getElementById('btnVerify').click();return false;">Open in Verify</a>`:''}
        <a href="#" data-action="kv"   data-key="${key}">Quick view</a>
        <a href="#" data-action="cert" data-key="${key}">View certificate</a>
        <a href="#" data-action="json" data-key="${key}">Download JSON</a>
      </div>
      ${img?`<details style="margin-top:8px"><summary>Preview</summary>
        <img src="${img}" referrerpolicy="no-referrer"
             style="max-width:100%;border-radius:8px;border:1px solid var(--line);margin-top:8px">
      </details>`:''}
    </div>`
  }

  async function fetchPosts(reset=false){
    const p = document.getElementById('platform').value.trim()
    const s = document.getElementById('search').value.trim()
    const i = document.getElementById('imgonly').checked
    const key = JSON.stringify({p,s,i})
    if(reset || key!==lastKey){ page=0; list.innerHTML=''; lastKey=key }

    // SAFE MODE: show all rows; apply filters if selected
    let q = supabase.from('echoprints').select('*')
    if(p) q=q.eq('platform',p)
    if(s) q=q.or([
      `title.ilike.%${s}%`,
      `post_title.ilike.%${s}%`,
      `caption.ilike.%${s}%`,
      `text.ilike.%${s}%`
    ].join(','))
    if(i) q=q.or('url.not.is.null,image_url.not.is.null,image.not.is.null,media_url.not.is.null,media.not.is.null,photo.not.is.null,photo_url.not.is.null,thumb_url.not.is.null,file_url.not.is.null')
    q = q.order('sent_at',{ascending:false}).order('created_at',{ascending:false}).range(page*pageSize, page*pageSize+pageSize-1)

    const { data, error } = await q
    if(error){ list.innerHTML = `<div class="muted">Error: ${error.message}</div>`; return }
    if(!data || (data.length===0 && page===0)){ list.innerHTML='<div class="muted">No posts found.</div>'; return }
    list.insertAdjacentHTML('beforeend', data.map(postCard).join(''))
    data.forEach(r => REC.set(keyOf(r), r))
    page++
  }

  document.getElementById('refresh').onclick = ()=>fetchPosts(true)
  document.getElementById('more').onclick = ()=>fetchPosts(false)

  if(!location.hash) location.hash = '#verify'
  route()
</script>
</html>
