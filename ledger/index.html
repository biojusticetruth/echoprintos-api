<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EchoprintOS • Ledger</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./theme.css?v=21" />
  <style>
    /* small layout tweaks just for this page */
    .verify-head { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .btn.clear-quiet { opacity:.55; border-color:transparent; }
    .btn.clear-quiet:hover { opacity:.9; }
    .verify-row { display:flex; gap:.5rem; flex-wrap:wrap; }
    .verify-row input { flex:1 1 260px; }
    .helper { font-size:.9rem; opacity:.75; margin-top:.5rem; }
    .list li { padding:.5rem 0; border-bottom:1px solid rgba(255,255,255,.06); }
    .list li:last-child { border-bottom:0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>

  <!-- Top Nav (glass) -->
  <header class="nav">
    <div class="wrap">
      <div class="row">
        <a class="brand" href="https://echoprintos.org/">EchoprintOS</a>
        <a class="active" href="/ledger/">Ledger</a>
        <a href="/about/">About</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Hero -->
    <section class="card glass edge glow-corners sheen">
      <span class="pill">LEDGER</span>
      <h1 class="display">Proof-of-Care Ledger</h1>
      <p class="lead">
        Canonical public ledger & archive for the BioJustice Philosophical Framework.
        Each entry lists the <b>EchoprintOS Record ID</b> and the official <b>TIMESTAMP (UTC)</b>.
        When present, a <em>View</em> button opens the source document. The ledger entry itself is the proof.
      </p>
    </section>

    <!-- Verify -->
    <section class="card glass sheen">
      <div class="verify-head">
        <h2 style="margin:0">Verify</h2>
        <button id="btnClear" class="btn clear-quiet">Clear</button>
      </div>

      <div class="verify-row" style="margin-top:.75rem">
        <input id="q" type="text" inputmode="text" autocomplete="off"
               placeholder="ECP-… (preferred) or 64-hex hash" />
        <button id="btnVerify" class="btn primary">Verify</button>
      </div>

      <div class="helper">
        Verify by pasting an <span class="mono">ECP-…</span> or a 64-hex hash.
        <button id="btnPaste" class="btn ghost xs" style="float:right;margin-top:.25rem">Paste</button>
      </div>

      <div id="verifyResult" class="result" style="margin-top:.75rem"></div>
    </section>

    <!-- Recent -->
    <section class="card glass">
      <h2>Recent</h2>
      <div id="recentStatus" class="lead">Loading…</div>
      <ul id="recent" class="list"></ul>
    </section>
  </main>

  <!-- Recent list loader (Supabase REST) -->
  <script>
  (async () => {
    // ── Update with your project values (kept from your working setup) ───────────
    const SUPABASE_URL = 'https://cyndhzyfaffprdebclnw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5bmRoenlmYWZmcHJkZWJjbG53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0OTQxNDUsImV4cCI6MjA3NzA3MDE0NX0.DynJLTGOKDlvLPy_W5jThsWYANens2yGKzY8am6XD6c';
    // ─────────────────────────────────────────────────────────────────────────────

    const statusEl = document.getElementById('recentStatus');
    const listEl = document.getElementById('recent');

    function esc(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    const qs = [
      'select=ecp_record_id,created_iso,url,source',
      'order=created_at.desc',
      'limit=12'
    ].join('&');

    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/echoprints?${qs}`, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`
        },
        cache: 'no-store'
      });

      if (!res.ok) {
        statusEl.textContent = `Read error: ${res.status}`;
        return;
      }

      const rows = await res.json();
      if (!rows.length) {
        statusEl.textContent = 'No records yet.';
        return;
      }

      statusEl.textContent = '';
      listEl.innerHTML = rows.map(r => {
        const ecp = r.ecp_record_id ? `<div class="mono" style="font-weight:600">${esc(r.ecp_record_id)}</div>` : '';
        const iso = r.created_iso ? `<small class="muted">${esc(r.created_iso)}</small>` : '';
        const src = r.source ? `<span class="pill" style="margin-left:.5rem;opacity:.7">${esc(r.source)}</span>` : '';
        const view = r.url ? `<a class="btn xs ghost" href="${esc(r.url)}" target="_blank" rel="noopener">View</a>` : '';
        return `<li>
                  <div style="display:flex; align-items:center; gap:.5rem; justify-content:space-between;">
                    <div>${ecp} ${src}</div>
                    ${view}
                  </div>
                  ${iso}
                </li>`;
      }).join('');
    } catch (e) {
      statusEl.textContent = 'Read error.';
      console.error(e);
    }
  })();
  </script>

  <!-- Your existing verify logic (IDs are unchanged) -->
  <script type="module" src="/ledger/js/main.hard.js?v=21"></script>
</body>
</html>
