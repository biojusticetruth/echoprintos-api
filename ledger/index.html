<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EchoprintOS • Ledger</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./theme.css?v=24" />
</head>
<body>

  <!-- Top Nav (glass) -->
  <header class="nav">
    <div class="wrap">
      <div class="row">
        <!-- Brand goes to echoprintos.org -->
        <a class="brand" href="https://echoprintos.org" target="_blank" rel="noopener">EchoprintOS</a>
        <a class="active" href="/ledger/">Ledger</a>
        <a href="/about/">About</a>
      </div>
    </div>
    <p class="lead">
  The BioJustice Institute develops ethical architectures grounded in care —
  aligning ethics, design, and data integrity into a single field of practice.
  Our work connects forensic independence, AI ethics, and systems accountability.
</p>
<p class="lead" style="margin-top:.6rem">
  “Care must be coded. Kindness doesn’t emerge by accident — it has to be entered into the system.”
</p>
<p class="lead" style="margin-top:.6rem">
  The Framework defines how care becomes calibration, equilibrium, and integrity across complex systems —
  translating intent into measurable structure for human and machine accountability.
</p>
  </header>

  <main class="wrap">

    <!-- Verification (only card at top) -->
    <section class="card glass sheen">
      <div class="bar">
        <h2>Verification</h2>
        <button id="btnReset" class="btn outline small">Reset</button>
      </div>

      <div class="verify-row">
        <input id="ecp" type="text" inputmode="text" autocomplete="off"
               placeholder="EchoprintOS Record ID (ECP-…)" />
        <input id="hash" type="text" inputmode="text" autocomplete="off"
               placeholder="Or enter full SHA-256 hash" />
        <button id="btnVerify" class="btn primary">Verify Record</button>
        <button id="btnPaste"  class="btn ghost">Paste</button>
      </div>

      <p class="muted" style="margin-top:.5rem">
        Verify by EchoprintOS Record ID or 64-hex hash.
      </p>
    </section>

    <!-- Recent feed -->
    <section class="card glass">
      <h2>Recent</h2>
      <div id="recentStatus" class="lead">Loading…</div>
      <ul id="recent" class="feed"></ul>
    </section>
  </main>

<script>
(async () => {
  const SUPABASE_URL = 'https://cyndhzyfaffprdebclnw.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5bmRoenlmYWZmcHJkZWJjbG53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0OTQxNDUsImV4cCI6MjA3NzA3MDE0NX0.DynJLTGOKDlvLPy_W5jThsWYANens2yGKzY8am6XD6c';

  const statusEl = document.getElementById('recentStatus');
  const listEl   = document.getElementById('recent');

  // helpers
  const pad  = (n, w=2) => String(n).padStart(w, '0');
  const esc  = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const fmt  = ts => { try { const d = new Date(ts); return isNaN(d)? ts : d.toLocaleString(); } catch { return ts; } };
  const ecpFrom = ts => {
    const d = new Date(ts);
    return `ECP-${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}${pad(d.getUTCMilliseconds(),3)}`;
  };

  // read by created_at (stable), newest first
  const qs = [
    'select=title,url,hash,source,created_at,created_iso',
    'order=created_at.desc',
    'limit=12'
  ].join('&');

  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/echoprints?${qs}`, {
      headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
      cache: 'no-store'
    });
    if (!res.ok) { statusEl.textContent = `Read error: ${res.status}`; return; }

    // rows newest → oldest
    let rows = await res.json();

    // hide obvious test/fake rows (title starts with "test", "img_", etc.)
    rows = rows.filter(r => {
      const t = (r.title || '').trim().toLowerCase();
      return t && !/^test\b|^img_|^coming soon\b/.test(t);
    });

    if (!rows.length) { statusEl.textContent = 'No records yet.'; return; }

    statusEl.textContent = '';

    listEl.innerHTML = rows.map(r => {
      const title = (r.url && r.url.startsWith('http'))
        ? `<a href="${esc(r.url)}" target="_blank" rel="noopener">${esc(r.title)}</a>`
        : esc(r.title);

      const ts = r.created_iso || r.created_at || '';
      const when = ts ? fmt(ts) : '';
      const ecp = ts ? ecpFrom(ts) : '';
      const hashShort = r.hash ? `${esc(r.hash.slice(0,10))}…` : '';

      return `
        <li class="echocard">
          <div class="row1">${title}${r.source ? ` <span class="pill">${esc(r.source)}</span>` : ''}</div>
          ${ecp ? `<div class="row2 mono">${esc(ecp)}</div>` : ''}
          <div class="row3 muted">${esc(when)} ${hashShort ? ` • <code class="mono" style="opacity:.7">${hashShort}</code>` : ''}</div>
        </li>`;
    }).join('');
  } catch (e) {
    console.error(e);
    statusEl.textContent = 'Read error.';
  }
})();
</script>
</body>
</html>
