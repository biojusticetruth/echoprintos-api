<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EchoprintOS — Generate • Verify • Recent</title>
<style>
  :root{--bg:#0b0f12;--fg:#e8ecef;--card:#12171b;--line:#232a31;--acc:#29d9e7}
  *{box-sizing:border-box}
  body{font:16px/1.5 Inter,system-ui,Segoe UI,Arial;margin:0;background:var(--bg);color:var(--fg)}
  a{color:var(--acc);text-decoration:none}
  .wrap{max-width:980px;margin:36px auto;padding:0 18px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:22px;margin:0}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0f1418;cursor:pointer}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin:14px 0}
  .inner{margin:14px 0}
  input[type=text],input[type=url],textarea,select{
    width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0f1418;color:var(--fg)
  }
  textarea{min-height:110px}
  button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#161d23;color:#e8ecef;cursor:pointer}
  button+button{margin-left:8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .col2{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:680px){ .col2{grid-template-columns:1fr 1fr} }
  .muted{opacity:.75;font-size:13px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;margin-left:6px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
  @media(min-width:680px){ .grid{grid-template-columns:1fr 1fr} }
  .center{justify-content:center}

  /* certificate overlay */
  #certOverlay{position:fixed;inset:0;background:rgba(5,8,12,.6);display:none;z-index:9999}
  #certPane{max-width:760px;margin:4vh auto;background:#fff;color:#111;border-radius:12px;padding:20px;overflow:auto;max-height:92vh;-webkit-overflow-scrolling:touch}
  #certPane .m{color:#666;font-size:13px}
  #certPane h2{margin:0 0 6px}
  #certPane .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  #certPane img{max-width:100%;border:1px solid #ddd;border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>EchoprintOS</h1>
    <nav>
      <a class="tab" href="#generate">Generate</a>
      <a class="tab" href="#verify">Verify</a>
      <a class="tab" href="#recent">Recent</a>
    </nav>
  </header>

  <!-- GENERATE -->
  <section id="generate" class="card">
    <h2 style="margin:0 0 8px 0;font-size:18px">Generate an Echoprint</h2>
    <div class="col2">
      <div>
        <label class="muted">Title (optional)</label>
        <input id="genTitle" type="text" placeholder="Untitled">
      </div>
      <div>
        <label class="muted">Platform (optional)</label>
        <select id="genPlatform">
          <option value="">—</option><option>Substack</option><option>LinkedIn</option><option>X</option>
          <option>Instagram</option><option>YouTube</option><option>TikTok</option>
        </select>
      </div>
      <div>
        <label class="muted">Permalink (optional)</label>
        <input id="genPermalink" type="url" placeholder="https://…">
      </div>
      <div>
        <label class="muted">Media URL (optional)</label>
        <input id="genURL" type="url" placeholder="https://…/image-or-video">
      </div>
    </div>

    <div class="card inner">
      <div class="col2">
        <div>
          <label class="muted">Hash from TEXT (browser SHA-256)</label>
          <textarea id="genText" placeholder="Paste any content to hash…"></textarea>
          <div class="row"><button id="btnHashText">Hash Text → SHA-256</button></div>
        </div>
        <div>
          <label class="muted">Hash from FILE (exact file bytes)</label>
          <input id="genFile" type="file" accept="*/*">
          <div class="row"><button id="btnHashFile">Hash File → SHA-256</button></div>
        </div>
      </div>
      <div style="margin-top:8px">
        <label class="muted">Or paste an existing hash (64 hex)</label>
        <input id="genHash" type="text" placeholder="6f1a…">
      </div>
    </div>

    <div class="row">
      <button id="btnInsert">Insert into EchoprintOS</button>
      <button id="btnClearGen">Clear</button>
    </div>
    <div id="genMsg" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- VERIFY -->
  <section id="verify" class="card">
    <h2 style="margin:0 0 8px 0;font-size:18px">Verify</h2>
    <label class="muted">Enter EchoprintOS Record ID (ECP-…), 64-hex hash, UUID, or a permalink</label>
    <div class="row">
      <input id="q" type="text" placeholder="ECP-… or 6f1a… or https://…">
      <button id="btnVerify">Verify</button>
      <button id="btnRecent" title="Show recent">Recent</button>
      <button id="btnClear"  title="Clear">Clear</button>
    </div>
    <div id="out" style="margin-top:14px"></div>
  </section>

  <!-- RECENT (live feed) -->
  <section id="recent" class="card">
    <h2 style="margin:0 0 8px 0;font-size:18px">Recent</h2>
    <div class="row" style="gap:8px;flex-wrap:wrap;margin:12px 0">
      <select id="platform">
        <option value="">All platforms</option>
        <option>Substack</option><option>LinkedIn</option><option>X</option>
        <option>Instagram</option><option>YouTube</option><option>TikTok</option>
      </select>
      <input id="search" type="text" placeholder="Search title…">
      <label style="display:flex;align-items:center;gap:6px;opacity:.85">
        <input id="imgonly" type="checkbox"> with image only
      </label>
      <button id="refresh">Refresh</button>
    </div>
    <div id="list" class="grid"></div>
    <div class="row center">
      <button id="more">Load more</button>
    </div>
  </section>
</div>

<!-- certificate overlay -->
<div id="certOverlay"><div id="certPane"></div></div>

<!-- —— ENV: put YOUR Supabase URL + anon key here —— -->
<script>
  window.__ENV = {
    SUPABASE_URL: 'https://YOUR-PROJECT.supabase.co',
    SUPABASE_ANON_KEY: 'eyJ…YOUR-ANON-KEY…'
  };
</script>

<!-- —— APP (reads/writes echoprints; verify; cards; certificates) —— -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  // ENV
  const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__ENV || {}
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){ alert('Missing SUPABASE env'); throw new Error('Missing SUPABASE env') }
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  // Helpers
  const $ = id => document.getElementById(id)
  const iso = t => t ? new Date(t).toISOString() : ''
  const isHex64 = s => /^[a-f0-9]{64}$/i.test((s||'').trim())
  const isUUID  = s => /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test((s||'').trim())
  const isURL   = s => /^https?:\/\//i.test((s||'').trim())

  // Normalize fields from possible legacy columns
  const pick=(r,keys)=>{ for(const k of keys){ if(r && r[k]!=null) return r[k] } return null }
  const titleOf = r => pick(r,['title','post_title','name','caption','text']) || 'Untitled'
  const linkOf  = r => pick(r,['permalink','perma_link','link','document_url','doc_url','file_url','url'])
  const imgOf   = r => pick(r,['url','image_url','image','media_url','media','photo','photo_url','thumb_url','file_url'])
  const tsRaw   = r => pick(r,['ots_attested_at','sent_at','timestamp_iso','created_at'])
  const recIdOf = r => pick(r,['record_id','id'])
  const ecpOf   = r => {
    const rid = (recIdOf(r)||'').toString()
    if(!rid) return ''
    return 'ECP-' + rid.replace(/-/g,'').slice(0,12).toUpperCase()
  }
  const tsLabel = r => r?.ots_attested_at ? 'Timestamp (OTS)' : (r?.sent_at ? 'Published' : 'Recorded')
  const tsShow  = r => (iso(tsRaw(r))||'').replace('T',' ').slice(0,19)

  // SHA-256 (browser)
  const toHex = buf => [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('')
  async function sha256OfText(txt){ const b=new TextEncoder().encode(txt); return toHex(await crypto.subtle.digest('SHA-256', b)) }
  async function sha256OfFile(file){ const b=await file.arrayBuffer();   return toHex(await crypto.subtle.digest('SHA-256', b)) }

  // Certificate overlay + downloads
  const overlay = document.getElementById('certOverlay'), pane=document.getElementById('certPane')
  function openCertificate(r){
    const n = {
      record_id: recIdOf(r), title: titleOf(r), hash: r.hash||null,
      platform: r.platform||null, permalink: linkOf(r), url: imgOf(r),
      ts: tsRaw(r)
    }
    pane.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Echoprint Certificate</h2>
        <button id="closeCert" style="border:0;background:#eee;padding:6px 10px;border-radius:8px;cursor:pointer">Close</button>
      </div>
      <div class="m">Preview</div>
      ${n.url?`<img src="${n.url}" alt="">`:''}
      <div style="margin-top:10px"><strong>Title:</strong> ${n.title}</div>
      <div style="margin-top:6px"><strong>Record ID:</strong> ${n.record_id||''} <span style="opacity:.65">(${ecpOf(r)})</span></div>
      <div style="margin-top:6px"><strong>SHA-256:</strong> <code>${n.hash||'N/A'}</code></div>
      <div style="margin-top:6px"><strong>${tsLabel(r)}:</strong> ${iso(n.ts)}</div>
      <div class="row">
        <button id="btnCertPNG">Download certificate (.png)</button>
        <button id="btnJSON">Download JSON</button>
        <button id="btnPrint">Print / Save PDF</button>
      </div>`
    overlay.style.display='block'
    document.getElementById('closeCert').onclick=()=>overlay.style.display='none'
    document.getElementById('btnPrint').onclick =()=>window.print()
    document.getElementById('btnJSON').onclick  =()=>downloadJSON(n)
    document.getElementById('btnCertPNG').onclick=()=>downloadCertificatePNG(n)
    overlay.onclick=(e)=>{ if(e.target===overlay) overlay.style.display='none' }
  }
  function downloadJSON(n){
    const cert={schema:'echoprint.v1',
      record:{record_id:n.record_id||null,title:n.title||null,hash:n.hash||null,
              platform:n.platform||null,permalink:n.permalink||null,url:n.url||null,
              sent_at:n.ts||null},
      proof:{hash_algo:'sha-256',
             verify_url:`${location.origin}${location.pathname}#verify?q=${encodeURIComponent(n.hash||n.permalink||'')}`,
             generated_at:new Date().toISOString()}}
    const a=document.createElement('a')
    a.href=URL.createObjectURL(new Blob([JSON.stringify(cert,null,2)],{type:'application/json'}))
    a.download=`${(n.record_id||n.hash||'echoprint').slice(0,16)}.echoprint.json`
    a.click(); URL.revokeObjectURL(a.href)
  }
  async function downloadCertificatePNG(n){
    const W=1080,H=1440,P=48,canvas=document.createElement('canvas'); canvas.width=W; canvas.height=H
    const ctx=canvas.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H)
    ctx.fillStyle='#111'; ctx.font='bold 48px Inter, Arial'; ctx.fillText('Echoprint Certificate', P, P+12)
    ctx.font='16px Inter, Arial'; ctx.fillStyle='#666'; ctx.fillText('Recorded through EchoprintOS provenance ledger.', P, P+48)
    let y=P+80
    if(n.url){
      try{
        const img=await new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=rej; i.src=n.url })
        const iw=Math.min(W-P*2, img.width), ih=iw*(img.height/img.width)
        ctx.drawImage(img,(W-iw)/2,y,iw,ih); y+=ih+24
      }catch{}
    }
    const row=(label,val)=>{ ctx.fillStyle='#111'; ctx.font='bold 22px Inter, Arial'; ctx.fillText(label,P,y); y+=26; ctx.font='18px Inter, Arial'; wrap(String(val||'N/A')); y+=14 }
    function wrap(text){ const max=W-P*2; let line=''; for(const w of text.split(' ')){ const t=(line?line+' ':'')+w; if(ctx.measureText(t).width>max){ ctx.fillText(line,P,y); y+=26; line=w } else line=t } if(line) ctx.fillText(line,P,y) }
    row('Title', n.title); row('Record ID', n.record_id); row('SHA-256', n.hash||'N/A'); row(tsLabel({ots_attested_at:n.ts})||'Timestamp', iso(n.ts))
    canvas.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`${(n.record_id||n.hash||'echoprint').slice(0,16)}.certificate.png`; a.click(); URL.revokeObjectURL(a.href) })
  }

  // Card rendering
  function cardBody(r){
    const ecp=ecpOf(r), dt=tsShow(r)
    const title=titleOf(r), rec=recIdOf(r)||''
    const hash=r.hash||''
    const link=linkOf(r), img=imgOf(r)
    return `
      <div class="muted" style="font-size:13px">EchoprintOS Record ID: ${rec} <span style="opacity:.65">(${ecp})</span></div>
      <div class="muted" style="font-size:13px">${tsLabel(r)}: ${dt||''}</div>
      ${hash?`<div class="muted" style="margin-top:6px">hash:</div><div style="word-break:break-all">${hash}</div>`:''}
      <div class="row" style="margin-top:6px">
        <a href="#" data-action="expand" data-key="${rec}">View</a>
        ${link?`<a href="${link}" target="_blank">Open post</a>`:''}
        ${img?`<a href="${img}" target="_blank">View image</a>`:''}
        ${hash?`<a href="#verify" data-action="open-verify" data-value="${hash}">Open in Verify</a>`:''}
        <a href="#" data-action="cert" data-key="${rec}">View certificate</a>
        <a href="#" data-action="json" data-key="${rec}">Download JSON</a>
        <a href="#" data-action="png"  data-key="${rec}">Download certificate</a>
      </div>
      <div id="x-${rec}" style="display:none;margin-top:10px"></div>`
  }
  function postCard(r){
    const dt=tsShow(r)
    return `<div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <strong>${titleOf(r)}</strong>
        <div>${r.platform?`<span class="pill">${r.platform}</span>`:''}${dt?`<span class="pill">${dt}</span>`:''}</div>
      </div>${cardBody(r)}
    </div>`
  }
  function expandCard(r, mountId){
    const n = { record_id:recIdOf(r), title:titleOf(r), hash:r.hash||null,
                platform:r.platform||null, permalink:linkOf(r), url:imgOf(r), ts:tsRaw(r) }
    const mount=document.getElementById(mountId)
    const dt=tsShow(r)
    mount.innerHTML = `
      ${n.url?`<div class="muted">media</div><div style="margin:6px 0"><a href="${n.url}" target="_blank">Open image</a></div>
        <details style="margin-top:6px"><summary>Preview</summary>
          <img src="${n.url}" style="max-width:100%;border-radius:8px;border:1px solid var(--line);margin-top:8px">
        </details>`:''}
      ${n.permalink?`<div class="muted" style="margin-top:6px">link</div><div><a href="${n.permalink}" target="_blank">${n.permalink}</a></div>`:''}
      <div class="muted" style="margin-top:6px">title</div><div>${n.title}</div>
      <div class="muted" style="margin-top:6px">record_id</div><div style="word-break:break-all">${n.record_id||''}</div>
      ${n.hash?`<div class="muted" style="margin-top:6px">hash</div><div style="word-break:break-all">${n.hash}</div>`:''}
      <div class="muted" style="margin-top:6px">${tsLabel(n)} </div><div>${dt}</div>
      <div class="muted" style="margin-top:10px">Verified by EchoprintOS</div>`
    mount.style.display='block'
  }

  // Click handlers
  const REC=new Map() // record_id -> row
  document.addEventListener('click',(e)=>{
    const t=e.target.closest('[data-action]'); if(!t) return
    e.preventDefault()
    const action=t.dataset.action
    if(action==='open-verify'){ const v=t.dataset.value; const q=$('q'); q.value=v; $('btnVerify').click(); return }
    const recId=t.dataset.key; const r=REC.get(recId); if(!r) return
    if(action==='expand') expandCard(r,'x-'+recId)
    if(action==='json')   downloadJSON({record_id:recId,title:titleOf(r),hash:r.hash,platform:r.platform,permalink:linkOf(r),url:imgOf(r),ts:tsRaw(r)})
    if(action==='cert')   openCertificate(r)
    if(action==='png')    downloadCertificatePNG({record_id:recId,title:titleOf(r),hash:r.hash,url:imgOf(r),ts:tsRaw(r)})
  })

  // Data fetch
  let page=0, pageSize=12, lastKey=''
  const list=$('list')
  async function fetchPosts(reset=false){
    const p=$('platform')?.value.trim()||'', s=$('search')?.value.trim()||'', i=$('imgonly')?.checked||false
    const k=JSON.stringify({p,s,i}); if(reset||k!==lastKey){ page=0; list.innerHTML=''; lastKey=k }
    let q=supabase.from('echoprints').select('*')
    if(p) q=q.eq('platform',p)
    if(s) q=q.or(['title','post_title','caption','text'].map(col=>`${col}.ilike.%${s}%`).join(','))
    if(i) q=q.or('url.not.is.null,image_url.not.is.null,image.not.is.null,media_url.not.is.null,media.not.is.null,photo.not.is.null,photo_url.not.is.null,thumb_url.not.is.null,file_url.not.is.null')
    q=q.order('created_at',{ascending:false}).range(page*pageSize, page*pageSize+pageSize-1)
    const { data, error } = await q
    if(error){ list.innerHTML=`<div class="muted">Error: ${error.message}</div>`; return }
    (data||[]).forEach(r=>REC.set(recIdOf(r), r))
    list.insertAdjacentHTML('beforeend', (data||[]).map(postCard).join(''))
    if((data||[]).length===0 && page===0) list.insertAdjacentHTML('beforeend','<div class="muted">No posts found.</div>')
    page++
  }
  $('refresh').onclick = ()=>fetchPosts(true)
  $('more').onclick    = ()=>fetchPosts(false)

  // Verify
  const out=$('out')
  function renderVerify(rows){
    if(!rows || rows.length===0){ out.innerHTML='<div class="muted">No records found.</div>'; return }
    out.innerHTML = rows.map(r=>`<div class="card"><strong>${titleOf(r)}</strong>${cardBody(r)}</div>`).join('')
  }
  $('btnVerify').onclick = async ()=>{
    const v = $('q').value.trim()
    if(!v){ out.innerHTML='<div class="muted">Enter something to verify.</div>'; return }
    const isECP = /^ECP[-\s]?([A-Z0-9]{8,})$/i.test(v)
    let data=null, error=null
    if(isHex64(v)){
      ({data,error}=await supabase.from('echoprints').select('*').eq('hash', v).limit(5))
    }else if(isURL(v)){
      ({data,error}=await supabase.from('echoprints').select('*').or(`permalink.eq.${encodeURIComponent(v)},perma_link.eq.${encodeURIComponent(v)}`).limit(5))
    }else if(isUUID(v)){
      ({data,error}=await supabase.from('echoprints').select('*').eq('record_id', v).limit(5))
    }else if(isECP){
      // fallback: get a page and match client-side against our ECP derived from uuid
      const r = await supabase.from('echoprints').select('*').order('created_at',{ascending:false}).limit(200)
      data = (r.data||[]).filter(row => ecpOf(row).toUpperCase().replace(/\s+/g,'') === v.toUpperCase().replace(/\s+/g,''))
    }else{
      // last resort: title contains
      ({data,error}=await supabase.from('echoprints').select('*').ilike('title', `%${v}%`).limit(5))
    }
    ;(data||[]).forEach(r=>REC.set(recIdOf(r), r))
    renderVerify(data||[])
  }
  $('btnRecent').onclick = async ()=>{
    const { data, error } = await supabase.from('echoprints').select('*').order('created_at',{ascending:false}).limit(10)
    ;(data||[]).forEach(r=>REC.set(recIdOf(r), r))
    out.innerHTML = error ? `<div class="muted">Error: ${error.message}</div>` : ''
    if(!error) renderVerify(data)
  }
  $('btnClear').onclick = ()=>{ $('q').value=''; out.innerHTML='' }

  // Generate
  function updateInsertState(){ const ok=isHex64($('genHash')?.value); const btn=$('btnInsert'); if(btn) btn.disabled=!ok }
  ;['genHash','genText','genFile'].forEach(id=>$(id)?.addEventListener('input', updateInsertState))
  $('btnHashText').onclick = async ()=>{
    const txt=($('genText')?.value||'').trim(); if(!txt){ $('genMsg').textContent='Enter text to hash.'; return }
    $('genHash').value = await sha256OfText(txt); $('genMsg').textContent='Text hashed ✓'; updateInsertState()
  }
  $('btnHashFile').onclick = async ()=>{
    const f=$('genFile')?.files?.[0]; if(!f){ $('genMsg').textContent='Choose a file to hash.'; return }
    $('genHash').value = await sha256OfFile(f); $('genMsg').textContent=`File hashed ✓ (${f.name})`; updateInsertState()
  }
  $('btnClearGen').onclick = ()=>{
    ['genTitle','genPermalink','genURL','genText','genHash'].forEach(id=>$(id)&&($(id).value=''))
    $('genPlatform').value=''; $('genFile').value=''; $('genMsg').textContent=''; updateInsertState()
  }
  $('btnInsert').onclick = async ()=>{
    const h = $('genHash')?.value || ''
    if(!isHex64(h)){ $('genMsg').textContent='Invalid or missing 64-hex hash.'; return }
    const row={
      title: ($('genTitle')?.value||'Untitled').trim(),
      hash: h.trim(),
      platform: ($('genPlatform')?.value||'').trim() || null,
      permalink: ($('genPermalink')?.value||'').trim() || null,
      url: ($('genURL')?.value||'').trim() || null,
      sent_at: new Date().toISOString()
    }
    $('genMsg').textContent='Saving…'
    const { data, error } = await supabase.from('echoprints').insert(row).select().single()
    $('genMsg').textContent = error ? `Error: ${error.message}` : 'Inserted ✓'
    if(!error){
      REC.set(recIdOf(data), data)
      // show in Verify + Recent; show certificate
      out.innerHTML = ''; renderVerify([data])
      list && list.insertAdjacentHTML('afterbegin', postCard(data))
      openCertificate(data)
    }
  }

  // Boot
  function setTabFromHash(){
    const tab=(location.hash||'#verify').slice(1)
    ;['generate','verify','recent'].forEach(id=>{ const el=document.getElementById(id); if(el) el.hidden=(id!==tab) })
  }
  addEventListener('hashchange', setTabFromHash)
  if(!location.hash) location.hash='#verify'
  setTabFromHash()
  updateInsertState()
  fetchPosts(true)
  $('btnRecent').click()
</script>
</body>
</html>
