<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EchoprintOS — Verify • Recent • Generate</title>

<style>
  :root { color-scheme: light dark; }
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;font:16px/1.5 Inter,system-ui,Segoe UI,Arial}
  a{color:#8ab4f8;text-decoration:none}
  .wrap{width:min(980px,100% - 24px);margin-inline:auto;padding:16px}

  /* panels */
  section{padding:14px;margin-block:12px;border-radius:12px;border:1px solid #28303a;background:#0f1318;color:#e8eaed}
  h1,h2,h3{margin:8px 0 10px;color:#e8eaed}

  /* inputs + buttons */
  input,textarea,select{width:100%;max-width:100%;padding:10px 12px;background:#0e1116;color:#e8eaed;border:1px solid #2c313a;border-radius:10px}
  input::placeholder,textarea::placeholder{color:#828b93}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{background:#1f6feb;color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  button:disabled{background:#2b2f36;color:#9aa0a6}

  /* recent grid */
  #recent-list{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:760px){ #recent-list{grid-template-columns:1fr 1fr} }

  /* cards */
  .card{position:relative;padding:14px;border-radius:14px;border:1px solid #28303a;background:#0f1318}
  .title{margin:0 0 8px;font-weight:600}
  .meta{margin:0 0 8px}
  .meta dt{font-weight:600;font-size:12px;color:#c3c8cf}
  .meta dd{margin:2px 0 10px;font:12.5px ui-monospace,Menlo,Consolas,monospace;color:#c3c8cf;word-break:break-all;line-height:1.35}
  .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .actions button{flex:1 1 calc(50% - 8px)}
  @media(min-width:760px){ .actions button{flex:0 0 auto} }

  /* ECP pill */
  .ecp{position:absolute;top:10px;right:12px;background:#0d1117;color:#8ab4f8;border:1px solid #2b3038;padding:2px 10px;border-radius:999px;font-weight:600;letter-spacing:.3px}

  /* certificate modal */
  dialog#cert-modal{width:min(760px,100% - 24px);border:0;border-radius:12px;padding:0}
  dialog::backdrop{background:rgba(0,0,0,.5)}
  .cert{background:#0f1318;color:#e8eaed;border:1px solid #28303a;border-radius:12px;padding:16px}
  .cert h3{margin:0 0 8px}
  .cert small{color:#9aa0a6}
  .cert pre{background:#0e1116;border:1px solid #2c313a;border-radius:10px;padding:10px;overflow:auto;color:#c3c8cf}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>EchoprintOS</h1></header>

  <!-- VERIFY -->
  <section id="verify">
    <h2>Verify</h2>
    <form id="verify-form" class="row" onsubmit="return false">
      <input id="verify-input" placeholder="Enter ECP-XXXXXXXXXXXX or 64-hex hash" autocomplete="off">
      <button id="verify-btn" type="submit">Verify</button>
      <button id="clear-btn" type="button">Clear</button>
    </form>
    <div id="verify-result" style="margin-top:10px"></div>
  </section>

  <!-- RECENT -->
  <section id="recent">
    <h2>Recent</h2>
    <div class="row">
      <button id="recent-btn" type="button">Refresh</button>
    </div>
    <div id="recent-list"></div>
  </section>

  <!-- GENERATE (browser hashing + DB insert) -->
  <section id="generate">
    <h2>Generate</h2>
    <div class="row"><input id="g-title" placeholder="Title (required)"></div>
    <div class="row">
      <input id="g-permalink" placeholder="Permalink (optional)">
      <input id="g-media" placeholder="Media URL (optional)">
    </div>
    <div class="row">
      <textarea id="g-text" placeholder="Paste text to hash (optional)"></textarea>
    </div>
    <div class="row">
      <input id="g-file" type="file">
      <input id="g-hash" placeholder="Or paste a 64-hex SHA-256">
    </div>
    <div class="row">
      <button id="btnHashText" type="button">Hash Text</button>
      <button id="btnHashFile" type="button">Hash File</button>
      <button id="btnInsert"   type="button">Insert</button>
      <button id="btnClear"    type="button">Clear</button>
    </div>
    <div id="g-status" style="margin-top:8px;color:#9aa0a6"></div>
  </section>
</div>

<!-- certificate modal -->
<dialog id="cert-modal"><div class="cert">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3 style="margin:0">Echoprint Certificate</h3>
    <button id="cert-close" type="button">Close</button>
  </div>
  <small id="cert-sub">Recorded by EchoprintOS</small>
  <pre id="cert-pre">{}</pre>
</div></dialog>

<!-- card template -->
<template id="card-template">
  <article class="card">
    <div class="ecp"></div>
    <h3 class="title"></h3>
    <dl class="meta">
      <dt>Hash</dt><dd class="hash"></dd>
      <dt>Timestamp (UTC)</dt><dd class="ts"></dd>
    </dl>
    <div class="actions">
      <button class="open-post" hidden>Open post</button>
      <button class="view-image" hidden>View image</button>
      <button class="open-in-verify">Open in Verify</button>
      <button class="view-cert">View certificate</button>
      <button class="download-json">Download JSON</button>
      <button class="download-cert">Download certificate</button>
    </div>
  </article>
</template>

<!-- Load environment (Supabase URL + anon key), then app logic -->
<script src="/ledger/env.js?v=43"></script>
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm';

  // --- ENV + client
  const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.__ENV || {};
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // --- utils
  const $  = (s,r=document)=>r.querySelector(s);
  const isHex64 = s => /^[a-f0-9]{64}$/i.test((s||'').trim());
  const isECP   = s => /^ECP[-\s]?[A-Z0-9]{10,}$/i.test((s||'').trim());

  // ECP = ECP- + first 12 hex of uuid/id
  const ecpOf = (r)=>{
    if (r.ecp_id && /^ECP[-A-Z0-9]{10,}$/.test(r.ecp_id)) return r.ecp_id;
    const base = ((r.record_id||r.id||'').toString().replace(/[^a-f0-9]/gi,'').slice(0,12)||'').toUpperCase();
    return base ? ('ECP-' + base) : 'ECP——————';
  };

  // DB timestamp fallback
  const tsOf = (r)=>{
    const t = r.sent_at || r.created_at || r.timestamp_iso || '';
    return t ? new Date(t).toISOString().replace('T',' ').replace('Z',' UTC') : '—';
  };

  // downloads
  function download(name, text){
    const blob = new Blob([text], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name; a.click(); URL.revokeObjectURL(a.href);
  }

  // CERT JSON
  async function certJSON(row){
    // If you later add a real Bitcoin endpoint, query it here:
    // const res = await fetch('/api/verify?hash=' + row.hash); const ots = await res.json();
    const ots = isHex64(row.hash) ? { anchored:false, status:'pending' } : { anchored:false, status:'no-hash' };
    return {
      standard: 'EchoprintOS v1',
      ecp_id: ecpOf(row),
      title: row.title || null,
      hash: row.hash || null,
      timestamps: {
        db_created_at: row.created_at || null,
        sent_at: row.sent_at || null,
        bitcoin: ots
      },
      links: {
        permalink: row.permalink || null,
        media: row.url || null,
        verify_ui: location.href
      }
    };
  }

  // render a card
  const T = $('#card-template');
  function renderCard(row){
    const n = T.content.cloneNode(true);
    $('.title', n).textContent = row.title || (row.permalink ? new URL(row.permalink).hostname : '(untitled)');
    $('.ecp',   n).textContent = ecpOf(row);
    $('.hash',  n).textContent = isHex64(row.hash) ? row.hash : '—';
    $('.ts',    n).textContent = tsOf(row);

    const bOpen  = $('.open-post', n);
    const bImg   = $('.view-image', n);
    const bVer   = $('.open-in-verify', n);
    const bCert  = $('.view-cert', n);
    const bJ     = $('.download-json', n);
    const bC     = $('.download-cert', n);

    if (row.permalink) { bOpen.hidden=false; bOpen.onclick=()=>window.open(row.permalink,'_blank'); }
    else if (row.url)  { bOpen.hidden=false; bOpen.textContent='Open link'; bOpen.onclick=()=>window.open(row.url,'_blank'); }

    if (row.url && /\.(png|jpe?g|gif|webp|mp4|mov|m4v)$/i.test(row.url)) {
      bImg.hidden=false; bImg.onclick=()=>window.open(row.url,'_blank');
    }

    bVer.onclick = ()=>{
      $('#verify-input').value = isHex64(row.hash||'') ? row.hash : ecpOf(row);
      $('#verify-btn').click();
      window.scrollTo({top:0,behavior:'smooth'});
    };

    bCert.onclick = async ()=>{
      const cert = await certJSON(row);
      $('#cert-pre').textContent = JSON.stringify(cert,null,2);
      $('#cert-modal').showModal();
    };
    $('#cert-close').onclick = ()=>$('#cert-modal').close();

    bJ.onclick = ()=>download('echoprint.json', JSON.stringify({
      ecp_id: ecpOf(row),
      record_id: row.record_id || row.id || null,
      title: row.title || null,
      hash: row.hash || null,
      url: row.url || null,
      permalink: row.permalink || null,
      platform: row.platform || null,
      created_at: row.created_at || null,
      sent_at: row.sent_at || null
    }, null, 2));

    bC.onclick = async ()=>{
      const cert = await certJSON(row);
      download('echoprint-certificate.json', JSON.stringify(cert,null,2));
    };

    return n;
  }

  // RECENT
  async function loadRecent(){
    const list = $('#recent-list'); list.innerHTML='';
    const { data, error } = await supabase
      .from('echoprints')
      .select('id,record_id,ecp_id,title,hash,created_at,sent_at,url,permalink,platform')
      .order('created_at',{ascending:false})
      .limit(50);
    if (error){ list.textContent = error.message; return }
    (data||[]).forEach(r => list.append(renderCard(r)));
  }

  // VERIFY
  async function doVerify(q){
    const out = $('#verify-result'); out.innerHTML='';
    if (!q){ out.textContent='Enter ECP-… or 64-hex hash'; return }
    let sel=null;
    if (isHex64(q)) sel = supabase.from('echoprints').select('*').eq('hash', q).limit(1);
    else if (isECP(q)) sel = supabase.from('echoprints').select('*').eq('ecp_id', q.toUpperCase()).limit(1);
    else { out.textContent='Not a valid ECP or 64-hex hash'; return }
    const { data, error } = await sel;
    if (error){ out.textContent=error.message; return }
    if (!data || !data.length){ out.textContent='No match'; return }
    out.append(renderCard(data[0]));
  }

  // GENERATE
  async function sha256Text(s){
    const enc=new TextEncoder().encode(s);
    const dig=await crypto.subtle.digest('SHA-256',enc);
    return [...new Uint8Array(dig)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function sha256File(f){
    const buf=await f.arrayBuffer();
    const dig=await crypto.subtle.digest('SHA-256',buf);
    return [...new Uint8Array(dig)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  $('#btnHashText').onclick=async()=>{
    const t=$('#g-text').value||''; $('#g-hash').value = t? await sha256Text(t) : '';
  };
  $('#btnHashFile').onclick=async()=>{
    const f=$('#g-file').files?.[0]; if(!f) return;
    $('#g-hash').value = await sha256File(f);
  };
  $('#btnClear').onclick=()=>{
    ['g-title','g-permalink','g-media','g-text','g-hash'].forEach(id=>$('#'+id).value='');
    $('#g-status').textContent='';
  };
  $('#btnInsert').onclick=async()=>{
    const title=$('#g-title').value.trim();
    const permalink=$('#g-permalink').value.trim()||null;
    const url=$('#g-media').value.trim()||null;
    const hash=$('#g-hash').value.trim();

    if(!title || !isHex64(hash)){ $('#g-status').textContent='Need a title and a valid 64-hex hash.'; return }
    $('#g-status').textContent='Inserting…';
    const { data, error } = await supabase.from('echoprints')
      .insert({ title, hash, permalink, url, sent_at:new Date().toISOString() })
      .select().single();
    $('#g-status').textContent = error ? ('Error: ' + error.message) : 'Inserted ✓';
    if(!error) loadRecent();
  };

  // WIRE
  $('#verify-form').addEventListener('submit', e=>{ e.preventDefault(); doVerify($('#verify-input').value.trim()); });
  $('#recent-btn').onclick = ()=>loadRecent();
  $('#clear-btn').onclick  = ()=>{ $('#verify-input').value=''; $('#verify-result').innerHTML=''; };

  // BOOT
  loadRecent();
</script>
</body>
</html>
