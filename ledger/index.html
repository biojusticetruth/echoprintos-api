<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EchoprintOS — Generate • Verify • Recent</title>

<!-- Minimal dark theme & layout -->
<style>
:root { color-scheme: light dark; --bg:#0b0c10; --fg:#e8eaed; --card:#0f1318; --line:#2a2f38; --muted:#9aa0a6; --link:#8ab4f8; --btn:#1f6feb; }
*,*::before,*::after{box-sizing:border-box}
html,body{margin:0;font:16px/1.5 Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--fg)}
a{color:var(--link);text-decoration:none}
.wrap{width:min(980px,100% - 24px);margin:24px auto}
header{display:flex;justify-content:space-between;align-items:center;margin:8px 0 16px}
h1{font-size:20px;margin:0}
h2{margin:8px 0 10px}
section{padding:14px;margin-block:12px;background:var(--card);border:1px solid var(--line);border-radius:12px}
.muted{color:var(--muted)}
.row{display:flex;gap:8px;flex-wrap:wrap}
input,textarea,select{width:100%;max-width:100%;padding:10px 12px;background:#0e1116;color:var(--fg);border:1px solid #2c313a;border-radius:10px}
input::placeholder,textarea::placeholder{color:#828b93}
label{font-size:13px;opacity:.85}

.btn{background:var(--btn);color:#fff;border:0;border-radius:10px;padding:10px 12px;cursor:pointer}
.btn:disabled{background:#2b2f36;color:var(--muted);cursor:default}
.btn--ghost{background:#2b2f36}
.btn--wide{flex:1 1 160px}
.actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
@media(min-width:760px){.btn--wide{flex:0 0 auto;min-width:140px}}

#recent-list{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
@media(min-width:760px){#recent-list{grid-template-columns:1fr 1fr}}

.card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
.card .title{margin:0 0 6px;font-weight:600}
.pills{display:flex;gap:8px;align-items:center;margin:0 0 8px}
.pill{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border:1px solid #2b3038;border-radius:999px;font-size:12.5px}
.pill.ecp{color:#8ab4f8;background:#0d1117;font-weight:600;letter-spacing:.3px}
.pill.badge{color:#c3c8cf;background:#12161c}
.meta dt{margin:6px 0 0;font-size:12px;color:var(--muted)}
.meta dd{margin:2px 0 6px}
.hash,.ts{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;color:#c3c8cf;word-break:break-all;line-height:1.35}

/* Certificate overlay (dark) */
#certOverlay{position:fixed;inset:0;background:rgba(5,8,12,.7);display:none;z-index:9999}
#certPane{max-width:820px;margin:4vh auto;background:#0f1318;color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:18px;max-height:92vh;overflow:auto}
#certHdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
#certHdr h3{margin:0;font-size:18px}
#certBody{display:grid;grid-template-columns:1fr 1fr;gap:12px}
#certBody .field{background:#0e1116;border:1px solid #2c313a;border-radius:10px;padding:10px}
#certBody .k{font-size:12px;color:var(--muted);margin-bottom:4px}
#certBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.code{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;word-break:break-all;color:#c3c8cf}
.note{font-size:12.5px;color:#c3c8cf;margin-top:4px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>EchoprintOS</h1>
    <div class="muted">Generate • Verify • Recent</div>
  </header>

  <!-- GENERATE -->
  <section id="generate">
    <h2>Generate an Echoprint</h2>
    <div class="row">
      <div style="flex:1 1 280px"><label>Title</label><input id="g-title" placeholder="Untitled" /></div>
      <div style="flex:1 1 280px"><label>Permalink (optional)</label><input id="g-permalink" type="url" placeholder="https://…" /></div>
      <div style="flex:1 1 280px"><label>Media URL (optional)</label><input id="g-media" type="url" placeholder="https://…/image.jpg" /></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div style="flex:1 1 360px">
        <label>Hash from TEXT (SHA-256)</label>
        <textarea id="g-text" placeholder="Paste content to hash…"></textarea>
        <div class="row"><button class="btn" id="btnHashText">Hash Text</button></div>
      </div>
      <div style="flex:1 1 260px">
        <label>Hash from FILE (SHA-256)</label>
        <input id="g-file" type="file" accept="*/*" />
        <div class="row"><button class="btn" id="btnHashFile">Hash File</button></div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div style="flex:1 1 420px"><label>Or paste an existing hash (64 hex)</label><input id="g-hash" placeholder="6f1a…" /></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnInsert">Insert</button>
      <button class="btn btn--ghost" id="btnClear" type="button">Clear</button>
      <div id="g-status" class="muted" style="align-self:center"></div>
    </div>
  </section>

  <!-- VERIFY -->
  <section id="verify">
    <h2>Verify</h2>
    <form id="verify-form" class="row">
      <input id="verify-input" placeholder="Enter EchoprintOS ID (ECP-YYYYMMDD-XXXXXXXX) or 64-hex hash" style="flex:1 1 420px" />
      <button class="btn" id="verify-btn" type="submit">Verify</button>
      <button class="btn btn--ghost" id="clear-btn" type="button">Clear</button>
    </form>
    <div id="verify-result" style="margin-top:12px"></div>
  </section>

  <!-- RECENT -->
  <section id="recent">
    <h2>Recent</h2>
    <div class="row"><button class="btn" id="recent-btn" type="button">Refresh</button></div>
    <div id="recent-list"></div>
  </section>
</div>

<!-- Card template -->
<template id="card-template">
  <article class="card">
    <h3 class="title"></h3>
    <div class="pills">
      <span class="pill ecp"></span>
      <span class="pill badge badge-bitcoin">Bitcoin: pending</span>
      <span class="pill badge platform" hidden></span>
    </div>
    <dl class="meta">
      <dt>Hash</dt><dd class="hash code">—</dd>
      <dt>Timestamp (UTC)</dt><dd class="ts code">—</dd>
    </dl>
    <div class="actions">
      <button class="btn btn--wide open-post"      hidden>Open post</button>
      <button class="btn btn--wide view-image"     hidden>View image</button>
      <button class="btn btn--wide open-in-verify">Open in Verify</button>
      <button class="btn btn--wide view-cert">View certificate</button>
      <button class="btn btn--wide download-json">Download JSON</button>
      <button class="btn btn--wide download-cert">Download certificate</button>
    </div>
  </article>
</template>

<!-- Certificate overlay -->
<div id="certOverlay"><div id="certPane">
  <div id="certHdr">
    <h3>Echoprint Certificate</h3>
    <button class="btn btn--ghost" id="closeCert" type="button">Close</button>
  </div>
  <div id="certBody">
    <div class="field"><div class="k">ECP ID</div><div id="c-ecp" class="code"></div></div>
    <div class="field"><div class="k">Title</div><div id="c-title"></div></div>
    <div class="field"><div class="k">SHA-256</div><div id="c-hash" class="code"></div></div>
    <div class="field"><div class="k">Timestamp (DB)</div><div id="c-db" class="code"></div></div>
    <div class="field"><div class="k">Timestamp (Sent)</div><div id="c-sent" class="code"></div></div>
    <div class="field"><div class="k">Bitcoin</div><div id="c-bitcoin" class="code">pending</div><div class="note">Anchor via API later.</div></div>
    <div class="field"><div class="k">Permalink</div><div id="c-link" class="code"></div></div>
    <div class="field"><div class="k">Media</div><div id="c-media" class="code"></div></div>
  </div>
  <div id="certBtns">
    <button class="btn" id="certSave"  type="button">Download JSON</button>
    <button class="btn btn--ghost" id="certPrint" type="button">Print</button>
  </div>
</div></div>

<!-- Single-script app -->
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm'

// ====== SET THESE TWO VALUES ======
const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co'  // ← your real URL
const SUPABASE_ANON_KEY = 'eyJ...'                       // ← your real anon key
// ===================================

if(!SUPABASE_URL || !SUPABASE_ANON_KEY){ alert('Missing Supabase URL / anon key'); throw new Error('env') }
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// helpers
const $  = (s,r=document)=>r.querySelector(s)
const $$ = (s,r=document)=>[...r.querySelectorAll(s)]
const isHex64 = s => /^[a-f0-9]{64}$/i.test((s||'').trim())
const toISO = t => t ? new Date(t).toISOString().replace('T',' ').replace('Z',' UTC') : ''
const looksEcp = s => /^ECP[-\s]?[A-Z0-9-]{10,}$/i.test((s||'').trim())

// Long ECP format: ECP-YYYYMMDD-XXXXXXXX (fallback if no stored ecp_id)
function ecpFrom(row){
  const stored = (row.ecp_id||'').toString()
  if(/^ECP-[A-Z0-9-]{10,}$/.test(stored)) return stored
  const dt = row.created_at ? new Date(row.created_at) : new Date()
  const ymd = String(dt.getUTCFullYear()) +
              String(dt.getUTCMonth()+1).padStart(2,'0') +
              String(dt.getUTCDate()).padStart(2,'0')
  const base = (row.record_id||row.id||'').toString().replace(/[^a-f0-9]/gi,'').slice(0,8).toUpperCase()
  return `ECP-${ymd}-${base||'XXXXXXXX'}`
}

// downloads
function download(name, text){ const blob=new Blob([text],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href) }

// certificate overlay
function openCert(row){
  $('#c-ecp').textContent   = ecpFrom(row)
  $('#c-title').textContent = row.title || '(untitled)'
  $('#c-hash').textContent  = isHex64(row.hash) ? row.hash : '—'
  $('#c-db').textContent    = toISO(row.created_at) || '—'
  $('#c-sent').textContent  = toISO(row.sent_at) || '—'
  $('#c-bitcoin').textContent = isHex64(row.hash) ? 'pending' : 'no-hash'
  $('#c-link').textContent  = row.permalink || '—'
  $('#c-media').textContent = row.url || '—'
  $('#certOverlay').style.display='block'
}
$('#closeCert').onclick = ()=>$('#certOverlay').style.display='none'
$('#certOverlay').onclick = (e)=>{ if(e.target===e.currentTarget) e.currentTarget.style.display='none' }
$('#certSave').onclick = ()=>{
  const cert = {
    standard:'EchoprintOS v1',
    ecp_id: $('#c-ecp').textContent,
    title: $('#c-title').textContent || null,
    hash: ($('#c-hash').textContent||'—')==='—'? null : $('#c-hash').textContent,
    timestamps:{
      db_created_at: ($('#c-db').textContent||'—')==='—'? null : $('#c-db').textContent,
      sent_at: ($('#c-sent').textContent||'—')==='—'? null : $('#c-sent').textContent,
      bitcoin:{ anchored:false, status: ($('#c-hash').textContent||'—')==='—' ? 'no-hash' : 'pending' }
    },
    links:{
      permalink: ($('#c-link').textContent||'—')==='—'? null : $('#c-link').textContent,
      media: ($('#c-media').textContent||'—')==='—'? null : $('#c-media').textContent,
      verify_ui: location.href
    }
  }
  download('echoprint-certificate.json', JSON.stringify(cert,null,2))
}
$('#certPrint').onclick = ()=>print()

// card renderer
const tpl = $('#card-template')
function renderCard(row){
  const n = tpl.content.cloneNode(true)
  $('.title',n).textContent = row.title || (row.permalink ? new URL(row.permalink).hostname : '(untitled)')
  $('.ecp',n).textContent   = ecpFrom(row)
  const plat = $('.platform',n)
  if(row.platform){ plat.hidden=false; plat.textContent = row.platform }

  $('.hash',n).textContent = isHex64(row.hash) ? row.hash : '—'
  const ts = row.sent_at || row.created_at || row.timestamp_iso || null
  $('.ts',n).textContent = ts ? toISO(ts) : '—'

  const bOpen=$('.open-post',n), bImg=$('.view-image',n), bVer=$('.open-in-verify',n), bCert=$('.view-cert',n), bJ=$('.download-json',n), bC=$('.download-cert',n)

  if(row.permalink){ bOpen.hidden=false; bOpen.onclick=()=>window.open(row.permalink,'_blank') }
  else if(row.url){ bOpen.hidden=false; bOpen.textContent='Open link'; bOpen.onclick=()=>window.open(row.url,'_blank') }

  if(row.url && /\.(png|jpe?g|gif|webp|mp4|mov|m4v)$/i.test(row.url)){ bImg.hidden=false; bImg.onclick=()=>window.open(row.url,'_blank') }

  bVer.onclick = ()=>{
    const code = ecpFrom(row)      // prefer ECP, per your request
    $('#verify-input').value = code
    $('#verify-btn').click()
    window.scrollTo({top:0,behavior:'smooth'})
  }

  bJ.onclick = ()=>{
    const slim = {
      ecp_id: ecpFrom(row),
      record_id: row.record_id || null,
      title: row.title || null,
      hash: row.hash || null,
      url: row.url || null,
      permalink: row.permalink || null,
      platform: row.platform || null,
      created_at: row.created_at || null,
      sent_at: row.sent_at || null
    }
    download('echoprint.json', JSON.stringify(slim,null,2))
  }

  bC.onclick = ()=>{
    const cert = {
      standard:'EchoprintOS v1',
      ecp_id: ecpFrom(row),
      title: row.title || null,
      hash: row.hash || null,
      timestamps:{
        db_created_at: row.created_at || null,
        sent_at: row.sent_at || null,
        bitcoin:{ anchored:false, status: isHex64(row.hash)?'pending':'no-hash' }
      },
      links:{ permalink: row.permalink || null, media: row.url || null, verify_ui: location.href }
    }
    download('echoprint-certificate.json', JSON.stringify(cert,null,2))
  }

  bCert.onclick = ()=>openCert(row)
  return n
}

// Recent
async function loadRecent(){
  const list = $('#recent-list'); list.innerHTML=''
  const { data, error } = await supabase
    .from('echoprints')
    .select('id,record_id,ecp_id,title,hash,created_at,sent_at,url,permalink,platform,timestamp_iso')
    .order('created_at',{ascending:false})
    .limit(50)
  if(error){ list.textContent = error.message; return }
  (data||[]).forEach(r=>list.append(renderCard(r)))
}

// Verify (ECP or hash)
async function doVerify(q){
  const out=$('#verify-result'); out.innerHTML=''
  if(!q){ out.textContent='Enter ECP-… or 64-hex hash'; return }

  // hash first
  if(isHex64(q)){
    const { data, error } = await supabase.from('echoprints').select('*').eq('hash', q).limit(1)
    if(error){ out.textContent = error.message; return }
    if(data && data.length){ out.append(renderCard(data[0])); return }
  }

  // then ECP (derive client-side against a recent window)
  if(looksEcp(q)){
    const key = q.toUpperCase().replace(/\s+/g,'')
    const { data, error } = await supabase.from('echoprints').select('*').order('created_at',{ascending:false}).limit(200)
    if(error){ out.textContent = error.message; return }
    const hit = (data||[]).find(r => ecpFrom(r).toUpperCase()===key)
    if(hit){ out.append(renderCard(hit)); return }
  }

  out.textContent='No match'
}

// Generate
async function sha256Text(s){ const enc=new TextEncoder().encode(s); const buf=await crypto.subtle.digest('SHA-256',enc); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('') }
async function sha256File(f){ const buf=await f.arrayBuffer(); const dig=await crypto.subtle.digest('SHA-256',buf); return [...new Uint8Array(dig)].map(b=>b.toString(16).padStart(2,'0')).join('') }

$('#btnHashText').onclick = async ()=>{ const t=$('#g-text').value||''; $('#g-hash').value = t ? await sha256Text(t) : '' }
$('#btnHashFile').onclick = async ()=>{ const f=$('#g-file').files?.[0]; if(!f) return; $('#g-hash').value = await sha256File(f) }
$('#btnClear').onclick    = ()=>{ ['g-title','g-permalink','g-media','g-text','g-hash'].forEach(id=>$('#'+id).value=''); $('#g-status').textContent='' }

$('#btnInsert').onclick = async ()=>{
  const title=($('#g-title').value||'Untitled').trim()
  const permalink=($('#g-permalink').value||'').trim()||null
  const url=($('#g-media').value||'').trim()||null
  const hash=($('#g-hash').value||'').trim()
  if(!isHex64(hash)){ $('#g-status').textContent='Need a valid 64-hex hash.'; return }
  $('#g-status').textContent='Saving…'
  const row={ title, hash, permalink, url, sent_at:new Date().toISOString() }
  const { data, error } = await supabase.from('echoprints').insert(row).select().single()
  if(error){ $('#g-status').textContent='Insert failed: '+error.message; return }
  $('#g-status').textContent='Inserted ✓'
  openCert(data)
  await loadRecent()
}

// Wire + boot
$('#verify-form').addEventListener('submit', e=>{ e.preventDefault(); doVerify($('#verify-input').value.trim()) })
$('#clear-btn').onclick = ()=>{ $('#verify-input').value=''; $('#verify-result').innerHTML='' }
$('#recent-btn').onclick= ()=>loadRecent()
loadRecent()
</script>
</body>
</html>
